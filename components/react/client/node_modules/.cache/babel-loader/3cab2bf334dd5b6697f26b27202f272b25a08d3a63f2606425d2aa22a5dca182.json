{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.doHash = exports.applyInner = exports.applyLeaf = void 0;\nconst ripemd160_1 = require(\"@noble/hashes/ripemd160\");\nconst sha256_1 = require(\"@noble/hashes/sha256\");\nconst sha512_1 = require(\"@noble/hashes/sha512\");\nconst codecimpl_1 = require(\"./generated/codecimpl\");\nfunction applyLeaf(leaf, key, value) {\n  if (key.length === 0) {\n    throw new Error(\"Missing key\");\n  }\n  if (value.length === 0) {\n    throw new Error(\"Missing value\");\n  }\n  const pkey = prepareLeafData(ensureHash(leaf.prehashKey), ensureLength(leaf.length), key);\n  const pvalue = prepareLeafData(ensureHash(leaf.prehashValue), ensureLength(leaf.length), value);\n  const data = new Uint8Array([...ensureBytes(leaf.prefix), ...pkey, ...pvalue]);\n  return doHash(ensureHash(leaf.hash), data);\n}\nexports.applyLeaf = applyLeaf;\nfunction applyInner(inner, child) {\n  if (child.length === 0) {\n    throw new Error(\"Inner op needs child value\");\n  }\n  const preimage = new Uint8Array([...ensureBytes(inner.prefix), ...child, ...ensureBytes(inner.suffix)]);\n  return doHash(ensureHash(inner.hash), preimage);\n}\nexports.applyInner = applyInner;\nfunction ensure(maybe, value) {\n  return maybe === undefined || maybe === null ? value : maybe;\n}\nconst ensureHash = h => ensure(h, codecimpl_1.ics23.HashOp.NO_HASH);\nconst ensureLength = l => ensure(l, codecimpl_1.ics23.LengthOp.NO_PREFIX);\nconst ensureBytes = b => ensure(b, new Uint8Array([]));\nfunction prepareLeafData(hashOp, lengthOp, data) {\n  const h = doHashOrNoop(hashOp, data);\n  return doLengthOp(lengthOp, h);\n}\n// doHashOrNoop will return the preimage untouched if hashOp == NONE,\n// otherwise, perform doHash\nfunction doHashOrNoop(hashOp, preimage) {\n  if (hashOp === codecimpl_1.ics23.HashOp.NO_HASH) {\n    return preimage;\n  }\n  return doHash(hashOp, preimage);\n}\n// doHash will preform the specified hash on the preimage.\n// if hashOp == NONE, it will return an error (use doHashOrNoop if you want different behavior)\nfunction doHash(hashOp, preimage) {\n  switch (hashOp) {\n    case codecimpl_1.ics23.HashOp.SHA256:\n      return (0, sha256_1.sha256)(preimage);\n    case codecimpl_1.ics23.HashOp.SHA512:\n      return (0, sha512_1.sha512)(preimage);\n    case codecimpl_1.ics23.HashOp.RIPEMD160:\n      return (0, ripemd160_1.ripemd160)(preimage);\n    case codecimpl_1.ics23.HashOp.BITCOIN:\n      return (0, ripemd160_1.ripemd160)((0, sha256_1.sha256)(preimage));\n    case codecimpl_1.ics23.HashOp.SHA512_256:\n      return (0, sha512_1.sha512_256)(preimage);\n  }\n  throw new Error(`Unsupported hashop: ${hashOp}`);\n}\nexports.doHash = doHash;\n// doLengthOp will calculate the proper prefix and return it prepended\n//   doLengthOp(op, data) -> length(data) || data\nfunction doLengthOp(lengthOp, data) {\n  switch (lengthOp) {\n    case codecimpl_1.ics23.LengthOp.NO_PREFIX:\n      return data;\n    case codecimpl_1.ics23.LengthOp.VAR_PROTO:\n      return new Uint8Array([...encodeVarintProto(data.length), ...data]);\n    case codecimpl_1.ics23.LengthOp.REQUIRE_32_BYTES:\n      if (data.length !== 32) {\n        throw new Error(`Length is ${data.length}, not 32 bytes`);\n      }\n      return data;\n    case codecimpl_1.ics23.LengthOp.REQUIRE_64_BYTES:\n      if (data.length !== 64) {\n        throw new Error(`Length is ${data.length}, not 64 bytes`);\n      }\n      return data;\n    case codecimpl_1.ics23.LengthOp.FIXED32_LITTLE:\n      return new Uint8Array([...encodeFixed32Le(data.length), ...data]);\n    // TODO\n    // case LengthOp_VAR_RLP:\n    // case LengthOp_FIXED32_BIG:\n    // case LengthOp_FIXED64_BIG:\n    // case LengthOp_FIXED64_LITTLE:\n  }\n\n  throw new Error(`Unsupported lengthop: ${lengthOp}`);\n}\nfunction encodeVarintProto(n) {\n  let enc = [];\n  let l = n;\n  while (l >= 128) {\n    const b = l % 128 + 128;\n    enc = [...enc, b];\n    l = l / 128;\n  }\n  enc = [...enc, l];\n  return new Uint8Array(enc);\n}\nfunction encodeFixed32Le(n) {\n  const enc = new Uint8Array(4);\n  let l = n;\n  for (let i = enc.length; i > 0; i--) {\n    enc[Math.abs(i - enc.length)] = l % 256;\n    l = Math.floor(l / 256);\n  }\n  return enc;\n}","map":{"version":3,"mappings":"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","names":["applyLeaf","leaf","key","value","length","Error","pkey","prepareLeafData","ensureHash","prehashKey","ensureLength","pvalue","prehashValue","data","Uint8Array","ensureBytes","prefix","doHash","hash","exports","applyInner","inner","child","preimage","suffix","ensure","maybe","undefined","h","codecimpl_1","HashOp","NO_HASH","l","LengthOp","NO_PREFIX","b","hashOp","lengthOp","doHashOrNoop","doLengthOp","SHA256","SHA512","RIPEMD160","BITCOIN","SHA512_256","VAR_PROTO","encodeVarintProto","REQUIRE_32_BYTES","REQUIRE_64_BYTES","FIXED32_LITTLE","encodeFixed32Le","n","enc","i","Math","abs","floor"],"sources":["../src/ops.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script","externalDependencies":[]}