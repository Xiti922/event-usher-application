{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.QueueingStreamingSocket = exports.ConnectionStatus = void 0;\nconst stream_1 = require(\"@cosmjs/stream\");\nconst xstream_1 = require(\"xstream\");\nconst streamingsocket_1 = require(\"./streamingsocket\");\nvar ConnectionStatus;\n(function (ConnectionStatus) {\n  ConnectionStatus[ConnectionStatus[\"Unconnected\"] = 0] = \"Unconnected\";\n  ConnectionStatus[ConnectionStatus[\"Connecting\"] = 1] = \"Connecting\";\n  ConnectionStatus[ConnectionStatus[\"Connected\"] = 2] = \"Connected\";\n  ConnectionStatus[ConnectionStatus[\"Disconnected\"] = 3] = \"Disconnected\";\n})(ConnectionStatus = exports.ConnectionStatus || (exports.ConnectionStatus = {}));\n/**\n * A wrapper around StreamingSocket that can queue requests.\n */\nclass QueueingStreamingSocket {\n  constructor(url) {\n    let timeout = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 10000;\n    let reconnectedHandler = arguments.length > 2 ? arguments[2] : undefined;\n    this.queue = [];\n    this.isProcessingQueue = false;\n    this.url = url;\n    this.timeout = timeout;\n    this.reconnectedHandler = reconnectedHandler;\n    const eventProducer = {\n      start: listener => this.eventProducerListener = listener,\n      stop: () => this.eventProducerListener = undefined\n    };\n    this.events = xstream_1.Stream.create(eventProducer);\n    this.connectionStatusProducer = new stream_1.DefaultValueProducer(ConnectionStatus.Unconnected);\n    this.connectionStatus = new stream_1.ValueAndUpdates(this.connectionStatusProducer);\n    this.socket = new streamingsocket_1.StreamingSocket(this.url, this.timeout);\n    this.socket.events.subscribe({\n      next: event => {\n        if (!this.eventProducerListener) throw new Error(\"No event producer listener set\");\n        this.eventProducerListener.next(event);\n      },\n      error: () => this.connectionStatusProducer.update(ConnectionStatus.Disconnected)\n    });\n  }\n  connect() {\n    this.connectionStatusProducer.update(ConnectionStatus.Connecting);\n    this.socket.connected.then(async () => {\n      this.connectionStatusProducer.update(ConnectionStatus.Connected);\n      return this.processQueue();\n    }, () => this.connectionStatusProducer.update(ConnectionStatus.Disconnected));\n    this.socket.connect();\n  }\n  disconnect() {\n    this.connectionStatusProducer.update(ConnectionStatus.Disconnected);\n    this.socket.disconnect();\n  }\n  reconnect() {\n    this.socket = new streamingsocket_1.StreamingSocket(this.url, this.timeout);\n    this.socket.events.subscribe({\n      next: event => {\n        if (!this.eventProducerListener) throw new Error(\"No event producer listener set\");\n        this.eventProducerListener.next(event);\n      },\n      error: () => this.connectionStatusProducer.update(ConnectionStatus.Disconnected)\n    });\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.socket.connected.then(() => {\n      if (this.reconnectedHandler) {\n        this.reconnectedHandler();\n      }\n    });\n    this.connect();\n  }\n  getQueueLength() {\n    return this.queue.length;\n  }\n  queueRequest(request) {\n    this.queue.push(request);\n    // We donâ€™t need to wait for the queue to be processed.\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.processQueue();\n  }\n  async processQueue() {\n    if (this.isProcessingQueue || this.connectionStatus.value !== ConnectionStatus.Connected) {\n      return;\n    }\n    this.isProcessingQueue = true;\n    let request;\n    while (request = this.queue.shift()) {\n      try {\n        await this.socket.send(request);\n        this.isProcessingQueue = false;\n      } catch (error) {\n        // Probably the connection is down; will try again automatically when reconnected.\n        this.queue.unshift(request);\n        this.isProcessingQueue = false;\n        return;\n      }\n    }\n  }\n}\nexports.QueueingStreamingSocket = QueueingStreamingSocket;","map":{"version":3,"mappings":"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","names":["ConnectionStatus","exports","QueueingStreamingSocket","constructor","url","timeout","reconnectedHandler","eventProducer","start","listener","eventProducerListener","stop","undefined","events","xstream_1","create","connectionStatusProducer","stream_1","Unconnected","connectionStatus","socket","streamingsocket_1","subscribe","next","event","Error","error","update","Disconnected","connect","Connecting","connected","then","Connected","processQueue","disconnect","reconnect","getQueueLength","queue","length","queueRequest","request","push","isProcessingQueue","value","shift","send","unshift"],"sources":["../src/queueingstreamingsocket.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script","externalDependencies":[]}