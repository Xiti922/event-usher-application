{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst encoding_1 = require(\"@iov/encoding\");\nconst bn_js_1 = __importDefault(require(\"bn.js\"));\nconst elliptic_1 = __importDefault(require(\"elliptic\"));\nconst hmac_1 = require(\"./hmac\");\nconst sha_1 = require(\"./sha\");\n/**\n * Raw values must match the curve string in SLIP-0010 master key generation\n *\n * @see https://github.com/satoshilabs/slips/blob/master/slip-0010.md#master-key-generation\n */\nvar Slip10Curve;\n(function (Slip10Curve) {\n  Slip10Curve[\"Secp256k1\"] = \"Bitcoin seed\";\n  Slip10Curve[\"Ed25519\"] = \"ed25519 seed\";\n})(Slip10Curve = exports.Slip10Curve || (exports.Slip10Curve = {}));\n/**\n * Reverse mapping of Slip10Curve\n */\nfunction slip10CurveFromString(curveString) {\n  switch (curveString) {\n    case Slip10Curve.Ed25519:\n      return Slip10Curve.Ed25519;\n    case Slip10Curve.Secp256k1:\n      return Slip10Curve.Secp256k1;\n    default:\n      throw new Error(`Unknown curve string: '${curveString}'`);\n  }\n}\nexports.slip10CurveFromString = slip10CurveFromString;\nclass Slip10RawIndex extends encoding_1.Uint32 {\n  static hardened(hardenedIndex) {\n    return new Slip10RawIndex(hardenedIndex + 2 ** 31);\n  }\n  static normal(normalIndex) {\n    return new Slip10RawIndex(normalIndex);\n  }\n  isHardened() {\n    return this.data >= 2 ** 31;\n  }\n}\nexports.Slip10RawIndex = Slip10RawIndex;\nconst secp256k1 = new elliptic_1.default.ec(\"secp256k1\");\n// Universal private key derivation accoring to\n// https://github.com/satoshilabs/slips/blob/master/slip-0010.md\nclass Slip10 {\n  static derivePath(curve, seed, path) {\n    let result = this.master(curve, seed);\n    for (const rawIndex of path) {\n      result = this.child(curve, result.privkey, result.chainCode, rawIndex);\n    }\n    return result;\n  }\n  static master(curve, seed) {\n    const i = new hmac_1.Hmac(sha_1.Sha512, encoding_1.Encoding.toAscii(curve)).update(seed).digest();\n    const il = i.slice(0, 32);\n    const ir = i.slice(32, 64);\n    if (curve !== Slip10Curve.Ed25519 && (this.isZero(il) || this.isGteN(curve, il))) {\n      return this.master(curve, i);\n    }\n    return {\n      chainCode: ir,\n      privkey: il\n    };\n  }\n  static child(curve, parentPrivkey, parentChainCode, rawIndex) {\n    let i;\n    if (rawIndex.isHardened()) {\n      const payload = new Uint8Array([0x00, ...parentPrivkey, ...rawIndex.toBytesBigEndian()]);\n      i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(payload).digest();\n    } else {\n      if (curve === Slip10Curve.Ed25519) {\n        throw new Error(\"Normal keys are not allowed with ed25519\");\n      } else {\n        // Step 1 of https://github.com/satoshilabs/slips/blob/master/slip-0010.md#private-parent-key--private-child-key\n        // Calculate I = HMAC-SHA512(Key = c_par, Data = ser_P(point(k_par)) || ser_32(i)).\n        // where the functions point() and ser_p() are defined in BIP-0032\n        const data = new Uint8Array([...Slip10.serializedPoint(curve, new bn_js_1.default(parentPrivkey)), ...rawIndex.toBytesBigEndian()]);\n        i = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(data).digest();\n      }\n    }\n    return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i);\n  }\n  /**\n   * Implementation of ser_P(point(k_par)) from BIP-0032\n   *\n   * @see https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki\n   */\n  static serializedPoint(curve, p) {\n    switch (curve) {\n      case Slip10Curve.Secp256k1:\n        return encoding_1.Encoding.fromHex(secp256k1.g.mul(p).encodeCompressed(\"hex\"));\n      default:\n        throw new Error(\"curve not supported\");\n    }\n  }\n  static childImpl(curve, parentPrivkey, parentChainCode, rawIndex, i) {\n    // step 2 (of the Private parent key â†’ private child key algorithm)\n    const il = i.slice(0, 32);\n    const ir = i.slice(32, 64);\n    // step 3\n    const returnChainCode = ir;\n    // step 4\n    if (curve === Slip10Curve.Ed25519) {\n      return {\n        chainCode: returnChainCode,\n        privkey: il\n      };\n    }\n    // step 5\n    const n = this.n(curve);\n    const returnChildKeyAsNumber = new bn_js_1.default(il).add(new bn_js_1.default(parentPrivkey)).mod(n);\n    const returnChildKey = Uint8Array.from(returnChildKeyAsNumber.toArray(\"be\", 32));\n    // step 6\n    if (this.isGteN(curve, il) || this.isZero(returnChildKey)) {\n      const newI = new hmac_1.Hmac(sha_1.Sha512, parentChainCode).update(new Uint8Array([0x01, ...ir, ...rawIndex.toBytesBigEndian()])).digest();\n      return this.childImpl(curve, parentPrivkey, parentChainCode, rawIndex, newI);\n    }\n    // step 7\n    return {\n      chainCode: returnChainCode,\n      privkey: returnChildKey\n    };\n  }\n  static isZero(privkey) {\n    return privkey.every(byte => byte === 0);\n  }\n  static isGteN(curve, privkey) {\n    const keyAsNumber = new bn_js_1.default(privkey);\n    return keyAsNumber.gte(this.n(curve));\n  }\n  static n(curve) {\n    switch (curve) {\n      case Slip10Curve.Secp256k1:\n        return new bn_js_1.default(\"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141\", 16);\n      default:\n        throw new Error(\"curve not supported\");\n    }\n  }\n}\nexports.Slip10 = Slip10;","map":{"version":3,"mappings":"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","names":["Slip10Curve","exports","slip10CurveFromString","curveString","Ed25519","Secp256k1","Error","Slip10RawIndex","encoding_1","hardened","hardenedIndex","normal","normalIndex","isHardened","data","secp256k1","elliptic_1","ec","Slip10","derivePath","curve","seed","path","result","master","rawIndex","child","privkey","chainCode","i","hmac_1","sha_1","toAscii","update","digest","il","slice","ir","isZero","isGteN","parentPrivkey","parentChainCode","payload","Uint8Array","toBytesBigEndian","serializedPoint","bn_js_1","childImpl","p","fromHex","g","mul","encodeCompressed","returnChainCode","n","returnChildKeyAsNumber","add","mod","returnChildKey","from","toArray","newI","every","byte","keyAsNumber","gte"],"sources":["../src/slip10.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script","externalDependencies":[]}